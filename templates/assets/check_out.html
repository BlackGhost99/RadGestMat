{% extends "base.html" %}
{% load static %}

{% block title %}Check-out - RadGestMat{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">
    <i class="bi bi-box-arrow-out me-2"></i>Check-out: {{ materiel.nom }} ({{ materiel.asset_id }})
  </h2>

  <!-- Détails du matériel -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Matériel</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Nom:</strong> {{ materiel.nom }}</p>
          <p><strong>Asset ID:</strong> {{ materiel.asset_id }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Numéro inventaire:</strong> {{ materiel.numero_inventaire }}</p>
          <p><strong>État:</strong> <span class="badge bg-success">{{ materiel.get_etat_technique_display }}</span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages d'erreur/succès -->
  {% if form.non_field_errors %}
  <div class="alert alert-danger">
    {{ form.non_field_errors }}
  </div>
  {% endif %}

  <!-- Formulaire d'attribution -->
  <div class="card">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Attribution</h5>
    </div>
    <div class="card-body">
      <form method="post" id="attribution_form">
        {% csrf_token %}
        <input type="hidden" name="action" value="attribution">
        {{ form.materiel }}

        <!-- Client Selection -->
        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label for="{{ form.client.id_for_label }}" class="form-label mb-0">
              <strong>Client *</strong>
            </label>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
              <i class="bi bi-plus-circle me-1"></i>Ajouter client
            </button>
          </div>
          {{ form.client }}
          {% if form.client.errors %}
            <div class="invalid-feedback d-block">{{ form.client.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Date retour prévue -->
        <div class="mb-4">
          <label for="{{ form.date_retour_prevue.id_for_label }}" class="form-label">
            <strong>Date retour prévue *</strong>
          </label>
          {{ form.date_retour_prevue }}
          {% if form.date_retour_prevue.errors %}
            <div class="invalid-feedback d-block">{{ form.date_retour_prevue.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Notes -->
        <div class="mb-4">
          <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
          {{ form.notes }}
          {% if form.notes.errors %}
            <div class="invalid-feedback d-block">{{ form.notes.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Boutons -->
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success btn-lg">
            <i class="bi bi-check-circle me-1"></i>Enregistrer l'attribution
          </button>
          <a href="{% url 'assets:materiel_detail' materiel.pk %}" class="btn btn-secondary btn-lg">
            <i class="bi bi-x-circle me-1"></i>Annuler
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal d'ajout de client rapide -->
<div class="modal fade" id="addClientModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Ajouter un nouveau client</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="quick_client_form">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_client">
        <div class="modal-body">
          <div class="mb-3">
            <label for="{{ quick_form.nom.id_for_label }}" class="form-label">{{ quick_form.nom.label }}</label>
            {{ quick_form.nom }}
            {% if quick_form.nom.errors %}
              <div class="invalid-feedback d-block">{{ quick_form.nom.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label for="{{ quick_form.type_client.id_for_label }}" class="form-label">{{ quick_form.type_client.label }}</label>
            {{ quick_form.type_client }}
            {% if quick_form.type_client.errors %}
              <div class="invalid-feedback d-block">{{ quick_form.type_client.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label for="{{ quick_form.email.id_for_label }}" class="form-label">{{ quick_form.email.label }}</label>
            {{ quick_form.email }}
            {% if quick_form.email.errors %}
              <div class="invalid-feedback d-block">{{ quick_form.email.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label for="{{ quick_form.telephone.id_for_label }}" class="form-label">{{ quick_form.telephone.label }}</label>
            {{ quick_form.telephone }}
            {% if quick_form.telephone.errors %}
              <div class="invalid-feedback d-block">{{ quick_form.telephone.errors.0 }}</div>
            {% endif %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-1"></i>Créer le client
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Gérer la soumission du formulaire de création rapide de client
  document.getElementById('quick_client_form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "assets:materiel_checkout" materiel.asset_id %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Fermer la modal
        bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();
        
        // Ajouter le client à la liste et le sélectionner
        const select = document.getElementById('client_select');
        const option = document.createElement('option');
        option.value = data.client_id;
        option.textContent = data.client_name;
        option.selected = true;
        select.appendChild(option);
        
        // Afficher message de succès
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
          <i class="bi bi-check-circle me-2"></i>Client "${data.client_name}" créé et sélectionné.
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.card').insertAdjacentElement('beforebegin', alertDiv);
        
        // Nettoyer le formulaire
        document.getElementById('quick_client_form').reset();
      } else {
        alert('Erreur: ' + JSON.stringify(data.errors));
      }
    })
    .catch(error => console.error('Erreur:', error));
  });
</script>
{% endblock %}
